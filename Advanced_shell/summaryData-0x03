#!/bin/bash 

# Directory containing the JSON files generated by the previous task
POKEMON_DATA_DIR="pokemon_data"

#Output CSV file name
OUTPUT_CSV="pokemon_report.csv"

# --- Preparation ---
echo "Starting report generation and average calculation..."
echo "Reading JSON files from: ${POKEMON_DATA_DIR}/"
echo "Output CSV will be saved as: ${OUTPUT_CSV}"
echo "----------------------------------------"

#Check if the data directory exists
if [ ! -d "${POKEMON_DATA_DIR}" ]; then
   echo "Error: Directory '${POKEMON_DATA_DIR}' not found. Please ensure Task 3 has been run successfully."
   exit 1
fi

#Create CSV file and add header
 echo "Name, Height (m), Weight (kg)" > "${OUTPUT_CSV}"

find "${POKEMON_DATA_DIR}" -maxdepth 1 -type f -name "*.json" | while read -r json_file; do
   echo "Processing ${json_file}..."

# Extract data from JSON file using jq 
   POKEMON_DATA=$(jq -r '"\(.name), \(.height / 10), \(.weight / 10)"' "${json_file}")

#Check if the extract with jq was successful
   if [ $? -ne 0 ]; then
   echo "Warning: Failed to extract data from '${json_file}' with jq. Skipping file." | tee -a "${GLOBAL_ERROR_LOG}"
   continue
   fi

#use awk for format the name
   echo "$POKEMON_DATA" | awk -F',' '{
   name_formatted = toupper(substr($1, 1, 1)) substr($1, 2)
   printf "%s,%.1f,%.1f\n", name_formatted, $2, $3
}' "${OUTPUT_CSV}"

done

echo "----------------------------------------"
echo "CSV report generated: ${OUTPUT_CSV}"

#calculating averages with awk
echo "Calculating average height and weight..."

awk -F',' '
BEGIN {
   total_height = 0
   total_weight = 0
   count = 0
   FS=","
}

NR > 1 {
   total_height += $2
   total_weight += $3
   count++
}

END{
  if (count > 0) {
        avg_height = total_height / count
        avg_weight = total_weight / count
        printf "Average Height: %.2fm\n", avg_height
        printf "Average weight: %.2fkg\n", avg_weight
 } else {
    print "No PokÃ©mon data found in the report to calculate averages."
 }
}' >> "${OUTPUT_CSV}"

echo "----------------------------------------"
echo "Script finished."